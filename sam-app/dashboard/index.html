<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Sensor Dashboard</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .controls { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .controls button { padding: 10px 20px; margin-right: 10px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        .controls button.active { background: #0056b3; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #333; }
        .stat-card .unit { font-size: 14px; color: #999; }
        .stat-card.good .value { color: #28a745; }
        .stat-card.warning .value { color: #ffc107; }
        .stat-card.danger .value { color: #dc3545; }
        .charts { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; }
        .chart-container h2 { font-size: 18px; color: #333; margin-bottom: 15px; }
        canvas { max-height: 300px; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CO2 Sensor Dashboard</h1>
        
        <div class="controls">
            <button onclick="loadData('24h')" class="active" id="btn-24h">Last 24 Hours</button>
            <button onclick="loadData('7d')" id="btn-7d">Last 7 Days</button>
            <button onclick="loadData('30d')" id="btn-30d">Last 30 Days</button>
        </div>

        <div class="stats">
            <div class="stat-card" id="current-temp">
                <h3>Current Temperature</h3>
                <div class="value">--</div>
                <div class="unit">°C</div>
            </div>
            <div class="stat-card" id="current-humidity">
                <h3>Current Humidity</h3>
                <div class="value">--</div>
                <div class="unit">%</div>
            </div>
            <div class="stat-card" id="current-co2">
                <h3>Current CO2</h3>
                <div class="value">--</div>
                <div class="unit">ppm</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h2>Temperature</h2>
                <canvas id="tempChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>Humidity</h2>
                <canvas id="humidityChart"></canvas>
            </div>
            <div class="chart-container">
                <h2>CO2 Level</h2>
                <canvas id="co2Chart"></canvas>
            </div>
        </div>

        <div class="loading" id="loading">Loading data...</div>
    </div>

    <script>
        const API_URL = 'https://co2.arsen.ganibek.com/data';
        let currentRange = '24h';
        let charts = {};

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Asia/Karachi'
            });
        }

        function getCO2Status(co2) {
            if (co2 < 800) return 'good';
            if (co2 < 1200) return 'warning';
            return 'danger';
        }

        async function loadData(range) {
            currentRange = range;
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${range}`).classList.add('active');
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(`${API_URL}?range=${range}`);
                const result = await response.json();
                const data = result.data || [];

                if (data.length === 0) {
                    document.getElementById('loading').textContent = 'No data available';
                    return;
                }

                document.getElementById('loading').style.display = 'none';

                // Update current values
                const latest = data[data.length - 1];
                document.querySelector('#current-temp .value').textContent = latest.temperature.toFixed(1);
                document.querySelector('#current-humidity .value').textContent = latest.humidity.toFixed(1);
                document.querySelector('#current-co2 .value').textContent = Math.round(latest.co2);
                
                const co2Card = document.getElementById('current-co2');
                co2Card.className = 'stat-card ' + getCO2Status(latest.co2);

                // Prepare chart data
                const labels = data.map(d => formatTime(d.timestamp));
                const temps = data.map(d => d.temperature);
                const humidity = data.map(d => d.humidity);
                const co2 = data.map(d => d.co2);

                // Update charts
                updateChart('tempChart', labels, temps, 'Temperature (°C)', '#ff6384');
                updateChart('humidityChart', labels, humidity, 'Humidity (%)', '#36a2eb');
                updateChart('co2Chart', labels, co2, 'CO2 (ppm)', '#4bc0c0');

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 'Error loading data';
            }
        }

        function updateChart(canvasId, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '20',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Load initial data
        loadData('24h');
        
        // Auto-refresh every 30 seconds
        setInterval(() => loadData(currentRange), 30000);
    </script>
</body>
</html>
